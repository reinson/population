<!DOCTYPE html>
<head>

    <style>

        .x.axis path.domain {
            display: none
        }
        .hidden {
            display: none
        }

        text {
            fill: #696969;
        }

        .bornIn {
            font-family: "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", Geneva, Verdana, sans-serif;
            font-size: 25px;
            font-style: normal;
            font-variant: normal;
            font-weight: 500;
            line-height: 15.4px;
        }

    </style>

    <meta charset="utf-8">
    <script src="//d3js.org/d3.v4.min.js"></script>

</head>
<script>

    var margin = {top: 40, right: 75, bottom: 120, left: 50};

    var width = 800 - margin.right - margin.left,
    height = 540 - margin.top - margin.bottom;

    var x = d3.scaleLinear()
        .domain([1923,2016])
        .range([0, width]);

    var y = d3.scaleLinear()
        .range([height, 0]);

    var color = d3.scaleLinear()
        .range(["#2c7bb6", "#00a6ca"]);

    var area = d3.area()
        .x(function(d,i) { return x(d.data.Aasta); })
        .y0(function(d) { return y(d[0]); })
        .y1(function(d) { return y(d[1]); });

    var stack = d3.stack()
       // .keys(["apples", "bananas", "cherries", "dates"])
        .order(d3.stackOrderNone)
        .offset(d3.stackOffsetWiggle );

    var xAxis = d3.axisBottom()
        .scale(x);

    var yAxis = d3.axisRight()
        .scale(y);

    function draw(error,data){

        var nested = d3.nest()
                .key(function(d){return d.Sugu})
                .entries(data);

        var keys = d3.keys(data[0]).filter(function(d){
            return ["Sugu", "Vanus teadmata", "Kokku", "Aasta"].indexOf(d) === -1;
        });

        data = stack.keys(keys)(nested[0].values);
        console.log(data);

        var y_min = d3.min(data[0],function(d){return d[0]});
        var y_max = d3.max(data[data.length-1], function(d){return d[1]});
        y.domain([y_min,y_max]);

        var svg = d3.select("body").append("svg")
            .attr("width",width + margin.right + margin.left)
            .attr("height",height + margin.top + margin.bottom)
        .append("g")
            .attr("transform","translate(" + margin.left + "," + margin.top + ")");

        //Append a defs (for definition) element to your SVG
        var defs = svg.append("defs");

        var cg = d3.interpolateRainbow;
        var percentages = d3.range(-100,101,8),
           // grad_colors =  ["#FDA860", "#FC8669", "#E36172", "#C64277", "#E36172", "#FC8669" ,"#FDA860"];//
           // grad_colors = ["#000428", "#004e92"];
            grad_colors = d3.range(0,1.01,0.04).map(function(d){return cg(d)});
        percentages = percentages.map(function(d,i){
            return {
                p: d,
                color: grad_colors[i%25]
            }
        });

        var grad_offsets = data.map(function(_,i){
           return percentages.map(function(d){
                return {
                    p : d.p + i*5.26,
                    color: d.color
                }
            });
        });

        defs.selectAll("linearGradient").data(grad_offsets)
            .enter()
            .append("linearGradient")
            .attr("id", function(_,i){return "lg"+i})
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "100%")
            .attr("y2", "0%")
            .each(function(grad_data){
                var linearGradient = d3.select(this);
                linearGradient.selectAll("stop").data(grad_data)
                    .enter().append("stop")
                    .attr("offset", function(d) { return d.p + "%"; })
                    .attr("stop-color", function(d) { return d.color; });
            });

        var age_range = svg.append("text").attr("x",-40 ).attr("class","hidden");
        var year_label = svg.append("text").attr("class","hidden");



        svg.selectAll("path")
            .data(data)
          .enter().append("path")
            .attr("d", area)
            .style("fill", function(_,i){ return  "url(#lg" + i +" )"})
            .on("mouseover", function(d){
                d3.select(this).attr("opacity",0.75);
                age_range.text(d.key).attr("y",function(){ return y((d[0][1]+d[0][0])/2 ) + 4}).classed("hidden",false)
            })
                .on("mousemove",function(d){debugger;
                    var mouse = d3.mouse(this),
                        mouse_year = Math.floor(x.invert(mouse[0])),

                        year_data = nested[0].values.filter(function(d){
                            return d.Aasta == mouse_year;
                        }),

                        stack_min = data[0].filter(function(d){
                            return d.data.Aasta == mouse_year;
                        })[0][0],

                        stack_max = data[data.length-1].filter(function(d){
                            return d.data.Aasta == mouse_year;
                        })[0][1];

                    year_label.text(mouse_year)
                            .attr("x",x(mouse_year))
                            .attr("y",y(stack_max)-10)
                            .classed("hidden",false);

                    year_line.attr("x1",x(mouse_year)).attr("x2",x(mouse_year))
                            .attr("y1",y(stack_max)).attr("y2",y(stack_min))
                            .classed("hidden",false);

                    var pop = year_data[0].Kokku.toString();
                    var pop = "Population of " + pop[0] + "'" + pop.substring(1,4) + "'" + pop.substring(4,8);

                    year_population.text(pop).classed("hidden",false);

                    debugger;

                    console.log(mouse_year);

                })
            .on("mouseout", function(d){
                d3.select(this).attr("opacity",1);
                age_range.classed("hidden",true);
                year_label.classed("hidden",true);
                year_population.classed("hidden",true)
            });

        var year_line = svg.append("line").attr("x1",100).attr("x2",100).attr("y1",20).attr("y2",400)
                .attr("stroke-width","2px").attr("stroke","white").attr("class","hidden")
                .attr("opacity",0.6).style("pointer-events","none");

        var year_population = svg.append("text").attr("class","hidden").text("tere").style("font-size","30px")
                .attr("x",0).attr("y",20)
                .style("text-anchor", "start");
               // .attr("transform", "rotate(90)" );

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + (height + 5) + ")")
            .call(xAxis);

        // Create legend box
        var lg_box_data = d3.range(0, 101, 4);
        lg_box_data = lg_box_data.map(function(d){
            return {
                p: d + "%",
                color : cg(d/100)
            }
        });

        var legend_box = svg.append("g").attr("transform","translate(0," + (height +60) + ")");

        defs.append("linearGradient")
            .attr("id","legend_lg")
            .attr("x1","0%")
            .attr("y1","0%")
            .attr("x2","100%")
            .attr("y2","0%")
            .selectAll("stop")
            .data(lg_box_data)
                .enter().append("stop")
                .attr("offset",function(d){return d.p})
                .attr("stop-color",function(d){return d.color });


        legend_box.append("rect").style("fill",  "url(#legend_lg)")
            .attr("width", width)
                .attr("height",20)
                .attr("x",0)
                .attr("y",10);

        var box_scale = x.copy().domain([1830,2015]);

        var boxAxis = d3.axisBottom()
            .scale(box_scale);

        legend_box.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0,30)")
            .call(boxAxis);

        legend_box.append("text").text("Birth years").attr("x",width/2)
            .style("text-anchor", "middle")
            .classed("bornIn",true)


    }

    function type(row) {
        d3.keys(row).forEach(function(d){
            if (d != "Sugu"){
                row[d] = +row[d];
            }
        });
        return row;
    }

    d3.tsv("RV021.csv")
            .row(type)
            .get(draw);


</script>